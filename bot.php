<?php

// config.php
define('FACEBOOK_PAGE_ACCESS_TOKEN', 'EAARRlvmJ1MMBP0wsO1KsTftohbeoQP26s3sErFqMz87Ewtw0rZCSOkafb8C7ZCWpILLpcwnFNSiZABgOj7mYdOzPrKJ5WjCm6NVQD2ijl70MalskCOFk8HcZAr1k0XEJhWqOo2R61xGm2mQYFKccPmu06ae7bhPa7omiNmiE1jUk5Q5Tsf0eOb2u9McLLDsjAyHcSntr6QZDZD');
define('FACEBOOK_GRAPH_API_URL', 'https://graph.facebook.com/v11.0/me/messages');
define('DB_PATH', 'users.db');

// Djezzy API Configuration
define('DJEZZY_CLIENT_ID', '6E6CwTkp8H1CyQxraPmcEJPQ7xka');
define('DJEZZY_CLIENT_SECRET', 'MVpXHW_ImuMsxKIwrJpoVVMHjRsa');
define('DJEZZY_BASE_URL', 'https://apim.djezzy.dz');

// CSRF Tokens for different APIs
define('CSRF_TOKEN_SIM_INFO', 'hMKb6f-EJjyyVeTxjZu5iPaW6p6RzDBGerxLxCGChnd4ILPscssRvBgqpq-oTXZPeOOu3K2FDpab4eWJepDwk17ruVeBu7boDvUUUT_Sw0krbVPJqvrVtLiWpQT0JisT_Q01QQk-E7d7sckhHCwMNP-uGhXKqXJcDm91XS41qgCZ4qaHGwN1J2Qkm7eZytw1b7lT4wti_sOz_-YkOTVLdnPZUJH9dlKvj2iyzxfLu-JjB7IeponCwgFDSf4FH2DDdhRUCCL-X1A6rjfvLw2wJe5jElfPBXL4MqEE-CK_s6bf0HeMRBOYX6B5U5-XcqgHehRTMBxHho3xSz3_XNOoMg8V6CeRTsF5EkbAakqmvKq4eoBw5QWKR-pRay7x05hn6_YfcPNALzhyoiE_esQmNXx7wPk2JtmAJs0utC257vhtc4pdLYnE6GU1Wj7tgTgXIVqhXCjuOCL1UiYAubdRAFM6B4mXdttdPUJ6rQDM2j060tYecNaBJI_6LDS89LS1ON83pebw3zeCP4FoD1A_4nAau5HLlmgB7-bFQsIUbQbNKG9Ucj7pAs64YqeZYPLbmOOL2XvXvCZsOQAfYYBa9CrTIjl7SkfxcsLABuHlmtKgX5Mo_cOD2bUei1R_6oumG68k17KWa5YmJM8zVrxa9MIDNUo_Su92EJYXkiFdLCqdiWcf83-t1ehy2XKbqCNkX5zALJ8NmAS0ZNQBQjXmneUJOeY3Lil6p78B41mfP4Qzwoh3Yztli3OifxGZvrZJX94eW8AvhGad-xCJnYnzMETUHKM-TSa_e91gRdyCvKY7pkNlHpG4PTLpdfWQtjbSXCHCqTR-1029-qsEcL5DdYGrZ6UW9gh47VeSiI3PBfE=');

define('CSRF_TOKEN_SUBSCRIPTION', 'wZwt1qJ/EIuSN/LvWzzqOEbTA9F+PNHp2SaAN2YI5qfjTvFy3yU/iSLormoiLVTaMuogXukq2MSFf0XyQOHcqfj5BS9GHYdEfo6tsgW4YvTR5KZjII9/DbcBkZpYKDm0g14twlFvJphrqd9ZBA8MalNKtPS6VqjVdeQMW9jyN1inNnmIESkw+pS0VqZMlqJe0Y9nUbzWElOf99b7PQl779zVh7LJTp/vrfhgTeDBb38RsTVfuB+fIivGVO2eI9LgE6fLLHJGPsnfBApr/3XeLgvbPQ9QizvG14kNxotC/M4c2hNXZU7x0vXC7BOKVrPPfyJHcC/F3PqsQz+7kbXw+HXMgQE1JFjGYoz1Lh1lBTEyiydMDz0tC8E7gZph2228DhVOXJso4Y72SFE0VSfSjGrtSxLYvQvUFWH25OdUwn5HLUFmPpm9M5e8UmL7sqJ+dqM0UlW7o1uF9qsWPuy3j54Ee9XOU+y0wkUsgkMlwUcabT3AzhmI71LfhYrOa/lfiAa1pgL3eXy21e4ExIflYtrWapwJ+Iu7Ovq33hsmGO7Ru4ldLEMekvGwn7oJFtR3i+l9oNUswRaKU0GnutYxf0sEGQsFxhrLU80H6FI7nrqcw9rmh01WjlKhSWIqEHPvtebt4bJCoaP3oZK+nYP2nOmkl6GH7iycJtSypSrGadalcsHn4BUmNukGD0sa189wvYU5hw5O94HBz9FF0ahv2W/32xCd9juXgnsAaKFzAOyWLIS4p5yyuApcnhVgq49AGdbmtkruktiBCF/F/u5J0GNGWnh1XVZdxfVVOgukb68nlud0XK+d6S3hCKnK50HyEuMTzwdu8qYfdl3iSZOK3H//DNMPw091dELVscS+ML7SeEskuXMEwZvvh9+VLWvW74QxZ5TydZ6yAeibISXQF5A==');

define('CSRF_TOKEN_1GO', '94u26y+DLq/dOQvv+brtfXtTiNx9ETySkLpqNy2wunLuSAzmQG6FY5GBUj3G38tktmKhdbzg9cIysOCGGjRB0eI6AM9DIh9QaOHRcx2EcFsotXDjTtuiWZdOfThAoeutA8wJAP8laKgxY2IwOcebGito22Kx63V3rLKBCqMYLq5mi6NVBkmBKB4hKhBsbV3BXSmrEw+vwZzguP5KjH10gWDsN1Fotz5p7GjZPk+iKUf+MnjSdlB5V1CWaqtcwppHClWEaSiP1nbrNblXV0w3IyBaGysNsOgEMxMdhWZitehTUcZbf+9sQl5Q64fLFkWfWNF10tvwI25rbjdnC5A6WLxsZEfc8smHYnIwTv2Y5r1w2idQDOSITqa2dULn0lzPF8rQ4l8cN8coU+u5MQivqyJ0ipuxHsNR0oaFI/0L81SvdnQMBya9nNgL5dAJIac82yN2ab1yU0/oQ4FxkNjUorKzeoxXvSAwDFbuFIyYHeLP++IabRhNFKWiUvRJ30xpjJGCMsQpkkbl2DCAmqaIjt2fxqNqFgLbjMGMd2T29HoBYGrKIfU7LDB7OnoJIHFbs7TunDSNsKv8w7D9wkiyenp8Af0zV5/Kf4xZCRkZjlWVlvBWAw3lYvDOQxNTSCzVxxB/KYY22kCEVJRxywnULCNymRWqdzTUB1oc8GO9z1t6HWddJLbSavIB80SY5CEATIi+qxQOPHgKHXym9RHy2Xx0i7cErkl0OcaeumHX1JjSXgEYqXYS6w9z+eB7FsFuZPSSmmtfnwjlHZ23+wqRAhHs4scWAr1m59FvSHiW3Fr5zchlW5oedwCjXDxfrGrT0tycYQ6O/r+y8ImEoVOBLMOqmSrMdBd3DR38gW0KeCCayXYYn5UdYU24l3SF/kZ9');

define('CSRF_TOKEN_1GO_FB', 'sd9gN7myL5OF6LS67H7pHkfJkVHlWhGuZ8J+c7fZ61pPCFtNT962z4phcpfp6pxcTd50YVJ2zrgTfgmf/V4gIB03qGqZrWn/qD1mrNqNDHH80BTXM7Md7srVCa8q7SsztF+N95ACfidqgneRb+0sZ7+wMWBy7bT+PBffHi6dDsObhdTJXa+dEuOu/0lnugoL2An2VLQ2BJ7BRf+N1gF2+ijXbtDvv1euzHJJwypQO1unNp3uMxV0imHETcsR0u6+5O1fz33W5zGK6UBT3uDnS/TuGzKNuYQP72ZDEfUKH50S1XXCyalUng8h2Fhl5zklRTmvf4313+7GqEeyxmpaRmaw1ho04Wva3RLRtl2mzFTCifM0P8Klnu1s/pdKUsvZkBqVW/Y5cTQruvu6681VSnYa+jxCahCP9LrbH9Dh/9veW0YU4GC5X3ZHXQNNzP3lsfu9yOVNkxcooK0JHLR2dwfulmwdK1A9oqdjh0ni0B8tOXghqLH0OAP4YPWyceLQyIXCno6GjmPq6BhLDKIo2rye4EA5ZDqrDF9mpJqDpVNnKVmGY/YMenezMgsQ5XNDb+jzcyOyLxc9Xa8vomHMJWZvIY/h8P3CUR/TocYzs3+EKBnt4L97n9uH+R9atvZJlSCAu6u7DrhAJJQgxeN3Z/XE9cYu3UxNFY9VqmFCrsTnJuF7iaYt6fYsPG7BqK9ZXFIVpDuj0u+lmpex8BHaGlcBpm/Fc6B086a35IdfX9FTiW3UcshPC/Kh+CG/4Xcfk7SkvDJxXqx/mhEfuNqfjbAIcpmlLqSA/dyv685J/3NX7wUQB61e94KsdJlpw1QY');

// Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function init_database() {
    $conn = new SQLite3(DB_PATH);
    $conn->exec('
        CREATE TABLE IF NOT EXISTS users (
            msisdn TEXT PRIMARY KEY,
            refresh_token TEXT NOT NULL,
            access_token TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ');
    $conn->exec('
        CREATE TABLE IF NOT EXISTS user_sessions (
            sender_id TEXT PRIMARY KEY,
            state_data TEXT NOT NULL,
            last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ');
    $conn->close();
}

function get_user_from_db($msisdn) {
    $conn = new SQLite3(DB_PATH);
    $stmt = $conn->prepare('SELECT * FROM users WHERE msisdn = ?');
    $stmt->bindValue(1, $msisdn, SQLITE3_TEXT);
    $result = $stmt->execute();
    $user = $result->fetchArray(SQLITE3_ASSOC);
    $conn->close();
    return $user;
}

function save_user_to_db($msisdn, $refresh_token, $access_token = null) {
    $conn = new SQLite3(DB_PATH);
    $stmt = $conn->prepare('
        INSERT OR REPLACE INTO users (msisdn, refresh_token, access_token, updated_at)
        VALUES (?, ?, ?, CURRENT_TIMESTAMP)
    ');
    $stmt->bindValue(1, $msisdn, SQLITE3_TEXT);
    $stmt->bindValue(2, $refresh_token, SQLITE3_TEXT);
    $stmt->bindValue(3, $access_token, SQLITE3_TEXT);
    $stmt->execute();
    $conn->close();
}

function update_access_token($msisdn, $access_token) {
    $conn = new SQLite3(DB_PATH);
    $stmt = $conn->prepare('
        UPDATE users SET access_token = ?, updated_at = CURRENT_TIMESTAMP
        WHERE msisdn = ?
    ');
    $stmt->bindValue(1, $access_token, SQLITE3_TEXT);
    $stmt->bindValue(2, $msisdn, SQLITE3_TEXT);
    $stmt->execute();
    $conn->close();
}

function save_user_session($sender_id, $state_data) {
    $conn = new SQLite3(DB_PATH);
    $stmt = $conn->prepare('
        INSERT OR REPLACE INTO user_sessions (sender_id, state_data, last_activity)
        VALUES (?, ?, CURRENT_TIMESTAMP)
    ');
    $stmt->bindValue(1, $sender_id, SQLITE3_TEXT);
    $stmt->bindValue(2, json_encode($state_data), SQLITE3_TEXT);
    $stmt->execute();
    $conn->close();
}

function get_user_session($sender_id) {
    $conn = new SQLite3(DB_PATH);
    $stmt = $conn->prepare('SELECT state_data FROM user_sessions WHERE sender_id = ?');
    $stmt->bindValue(1, $sender_id, SQLITE3_TEXT);
    $result = $stmt->execute();
    $row = $result->fetchArray(SQLITE3_ASSOC);
    $conn->close();
    
    if ($row && isset($row['state_data'])) {
        return json_decode($row['state_data'], true);
    }
    return null;
}

function delete_user_session($sender_id) {
    $conn = new SQLite3(DB_PATH);
    $stmt = $conn->prepare('DELETE FROM user_sessions WHERE sender_id = ?');
    $stmt->bindValue(1, $sender_id, SQLITE3_TEXT);
    $stmt->execute();
    $conn->close();
}

// ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
init_database();

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙÙŠØ³Ø¨ÙˆÙƒ
function send_facebook_message($recipient_id, $message_text, $quick_replies = null) {
    $url = FACEBOOK_GRAPH_API_URL;
    $params = [
        "access_token" => FACEBOOK_PAGE_ACCESS_TOKEN
    ];
    
    $data = [
        "recipient" => [
            "id" => $recipient_id
        ],
        "message" => [
            "text" => $message_text
        ]
    ];
    
    if ($quick_replies) {
        $data["message"]["quick_replies"] = $quick_replies;
    }

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url . '?' . http_build_query($params));
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($http_code != 200) {
        error_log("Error sending message: " . $response);
    }
    
    return $http_code == 200;
}

// ÙˆØ¸Ø§Ø¦Ù Djezzy API Ø§Ù„ÙƒØ§Ù…Ù„Ø©
function register_msisdn($msisdn) {
    $url = DJEZZY_BASE_URL . "/oauth2/registration";
    $msisdn = '213' . substr($msisdn, 1);
    
    $headers = [
        "Content-Type: application/x-www-form-urlencoded",
        "Accept: */*",
        "User-Agent: Dalvik/2.1.0 (Linux; U; Android 8.1; SM-J230 Build/MRA58K)",
        "Host: apim.djezzy.dz",
        "Connection: Keep-Alive",
        "Accept-Encoding: gzip"
    ];

    $data = [
        "scope" => "smsotp",
        "client_id" => DJEZZY_CLIENT_ID,
        "msisdn" => $msisdn
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($http_code == 200) {
        return [true, $msisdn];
    }
    
    error_log("Registration failed: HTTP $http_code - $response");
    return [false, null];
}

function get_auth_token($msisdn, $otp) {
    $url = DJEZZY_BASE_URL . "/oauth2/token";
    
    $headers = [
        "Content-Type: application/x-www-form-urlencoded",
        "Accept: */*",
        "User-Agent: Dalvik/2.1.0 (Linux; U; Android 6.0; LG-X230 Build/MRA58K)",
        "Host: apim.djezzy.dz",
        "Connection: Keep-Alive",
        "Accept-Encoding: gzip"
    ];

    $data = [
        "scope" => "openid",
        "client_secret" => DJEZZY_CLIENT_SECRET,
        "client_id" => DJEZZY_CLIENT_ID,
        "otp" => $otp,
        "mobileNumber" => $msisdn,
        "grant_type" => "mobile"
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($http_code == 200) {
        $response_data = json_decode($response, true);
        if (isset($response_data['refresh_token'])) {
            return [true, $response_data['refresh_token']];
        }
    }
    
    error_log("Auth token failed: HTTP $http_code - $response");
    return [false, null];
}

function refresh_access_token($refresh_token) {
    $url = DJEZZY_BASE_URL . "/oauth2/token";
    
    $headers = [
        "Content-Type: application/x-www-form-urlencoded",
        "Accept: */*",
        "User-Agent: Dalvik/2.1.0 (Linux; U; Android 6.0; LG-X230 Build/MRA58K)",
        "Host: apim.djezzy.dz",
        "Connection: Keep-Alive",
        "Accept-Encoding: gzip"
    ];

    $data = [
        "scope" => "openid",
        "client_secret" => DJEZZY_CLIENT_SECRET,
        "client_id" => DJEZZY_CLIENT_ID,
        "grant_type" => "refresh_token",
        "refresh_token" => $refresh_token
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($http_code == 200) {
        $response_data = json_decode($response, true);
        if (isset($response_data['access_token'])) {
            return [true, $response_data['access_token']];
        }
    }
    
    error_log("Refresh token failed: HTTP $http_code - $response");
    return [false, null];
}

function get_access_token_for_user($msisdn) {
    $user = get_user_from_db($msisdn);
    if ($user) {
        $refresh_token = $user['refresh_token'];
        $stored_access_token = $user['access_token'];
        
        if ($stored_access_token) {
            return [true, $stored_access_token];
        }
        
        list($success, $new_access_token) = refresh_access_token($refresh_token);
        if ($success) {
            update_access_token($msisdn, $new_access_token);
            return [true, $new_access_token];
        }
    }
    
    return [false, null];
}

function get_sim_card_info($access_token, $msisdn) {
    $url = DJEZZY_BASE_URL . "/djezzy-api/api/v1/subscribers/$msisdn";
    
    $params = [
        'include' => "connected-products,subscription-types"
    ];

    $headers = [
        'User-Agent: Djezzy/2.7.3',
        'Connection: Keep-Alive',
        'Accept: */*',
        'Cache-Control: no-store',
        'Accept-Encoding: gzip',
        'x-csrf-token: ' . CSRF_TOKEN_SIM_INFO,
        'Host: apim.djezzy.dz',
        'Authorization: Bearer ' . $access_token
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url . '?' . http_build_query($params));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($http_code == 200) {
        $response_data = json_decode($response, true);
        $sim_info = analyze_sim_card_response($response_data);
        return [true, $sim_info];
    }
    
    error_log("SIM card info failed: HTTP $http_code - $response");
    return [false, "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: HTTP $http_code"];
}

function analyze_sim_card_response($response_data) {
    $sim_info = [];
    
    try {
        if (isset($response_data['data'])) {
            $data = $response_data['data'];
            
            $sim_info['msisdn'] = $data['msisdn'] ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            $sim_info['imsi'] = $data['imsi'] ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            $sim_info['status'] = $data['status'] ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            $sim_info['customerType'] = $data['customerType'] ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            $sim_info['language'] = $data['language'] ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            
            if (isset($data['credit'])) {
                $credit = $data['credit'];
                $sim_info['balance'] = $credit['balance'] ?? 0;
                $sim_info['currency'] = $credit['currency'] ?? 'DZD';
            }
            
            if (isset($response_data['subscription-types']) && !empty($response_data['subscription-types'])) {
                $subscriptions = $response_data['subscription-types'];
                $subscription = $subscriptions[0];
                $sim_info['plan_name'] = $subscription['name'] ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                $sim_info['plan_type'] = $subscription['type'] ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            }
            
            if (isset($response_data['connected-products']) && !empty($response_data['connected-products'])) {
                $connected_products = $response_data['connected-products'];
                $sim_info['active_products'] = [];
                
                foreach (array_slice($connected_products, 0, 5) as $product) {
                    $product_info = [
                        'name' => $product['name'] ?? 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                        'status' => $product['status'] ?? 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
                    ];
                    
                    if (isset($product['expiryDate'])) {
                        $product_info['expiry_date'] = $product['expiryDate'];
                    }
                    if (isset($product['activationDate'])) {
                        $product_info['activation_date'] = $product['activationDate'];
                    }
                    
                    $sim_info['active_products'][] = $product_info;
                }
            }
            
            if (isset($data['lastRechargeDate'])) {
                $sim_info['last_recharge'] = $data['lastRechargeDate'];
            }
            if (isset($data['activationDate'])) {
                $sim_info['activation_date'] = $data['activationDate'];
            }
            if (isset($data['expiryDate'])) {
                $sim_info['expiry_date'] = $data['expiryDate'];
            }
        }
        
        return $sim_info;
        
    } catch (Exception $e) {
        error_log("Error analyzing SIM card response: " . $e->getMessage());
        return ["error" => "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " . $e->getMessage()];
    }
}

function format_sim_card_info($sim_info) {
    if (isset($sim_info['error'])) {
        return "âŒ {$sim_info['error']}";
    }
    
    $formatted_message = "ğŸ“± **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬ÙŠØ²ÙŠ**\n\n";
    
    $formatted_message .= "ğŸ“ **Ø§Ù„Ø±Ù‚Ù…:** " . ($sim_info['msisdn'] ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±') . "\n";
    $formatted_message .= "ğŸ†” **Ø§Ù„Ø­Ø§Ù„Ø©:** " . ($sim_info['status'] ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±') . "\n";
    $formatted_message .= "ğŸ‘¤ **Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ØªØ±Ùƒ:** " . ($sim_info['customerType'] ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±') . "\n";
    
    if (isset($sim_info['balance'])) {
        $formatted_message .= "ğŸ’° **Ø§Ù„Ø±ØµÙŠØ¯:** {$sim_info['balance']} " . ($sim_info['currency'] ?? 'DZD') . "\n";
    } else {
        $formatted_message .= "ğŸ’° **Ø§Ù„Ø±ØµÙŠØ¯:** ØºÙŠØ± Ù…ØªÙˆÙØ±\n";
    }
    
    if (isset($sim_info['plan_name'])) {
        $formatted_message .= "ğŸ“¦ **Ø§Ù„Ø¨Ø§Ù‚Ø©:** {$sim_info['plan_name']}\n";
    }
    
    if (isset($sim_info['expiry_date']) && $sim_info['expiry_date'] != 'ØºÙŠØ± Ù…ØªÙˆÙØ±') {
        $formatted_message .= "ğŸ“… **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:** {$sim_info['expiry_date']}\n";
    }
    
    if (isset($sim_info['last_recharge']) && $sim_info['last_recharge'] != 'ØºÙŠØ± Ù…ØªÙˆÙØ±') {
        $formatted_message .= "â° **Ø¢Ø®Ø± Ø´Ø­Ù†:** {$sim_info['last_recharge']}\n";
    }
    
    if (isset($sim_info['activation_date']) && $sim_info['activation_date'] != 'ØºÙŠØ± Ù…ØªÙˆÙØ±') {
        $formatted_message .= "ğŸ•’ **ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙØ¹ÙŠÙ„:** {$sim_info['activation_date']}\n";
    }
    
    if (isset($sim_info['active_products']) && !empty($sim_info['active_products'])) {
        $formatted_message .= "\nğŸ¯ **Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©:**\n";
        foreach (array_slice($sim_info['active_products'], 0, 3) as $product) {
            $product_text = "â€¢ {$product['name']} - {$product['status']}";
            if (isset($product['expiry_date'])) {
                $product_text .= " (ÙŠÙ†ØªÙ‡ÙŠ: {$product['expiry_date']})";
            }
            $formatted_message .= $product_text . "\n";
        }
    }
    
    return $formatted_message;
}

// ÙˆØ¸Ø§Ø¦Ù ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
function send_subscription_product1_request($access_token, $msisdn) {
    $url = DJEZZY_BASE_URL . "/djezzy-api/api/v1/subscribers/$msisdn/subscription-product?include=";
    
    $headers = [
        "Content-Type: application/json",
        "Authorization: Bearer $access_token",
        "User-Agent: Dalvik/2.1.0 (Linux; U; Android 8.0; OS-G23 Build/MRA58K)",
        "Host: apim.djezzy.dz",
        "x-csrf-token: " . CSRF_TOKEN_SUBSCRIPTION,
        "Connection: Keep-Alive",
        "Accept-Encoding: gzip"
    ];
    
    $data = [
        "data" => [
            "id" => "GIFTWALKWIN",
            "type" => "products",
            "meta" => [
                "services" => [
                    "steps" => 10000,
                    "code" => "GIFTWALKWIN2GO",
                    "id" => "WALKWIN"
                ]
            ]
        ]
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    return $http_code == 200;
}

function send_subscription_product2_request($access_token, $msisdn) {
    $url = DJEZZY_BASE_URL . "/djezzy-api/api/v1/subscribers/$msisdn/subscription-product?include=";
    
    $headers = [
        "Content-Type: application/json",
        "Authorization: Bearer $access_token",
        "User-Agent: Dalvik/2.1.0 (Linux; U; Android 8.0; OS-G23 Build/MRA58K)",
        "Host: apim.djezzy.dz",
        "x-csrf-token: " . CSRF_TOKEN_SUBSCRIPTION,
        "Connection: Keep-Alive",
        "Accept-Encoding: gzip"
    ];
    
    $data = [
        "data" => [
            "id" => "BTLINTSPEEDDAY2Go",
            "type" => "products"
        ]
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    return $http_code == 200;
}

function send_subscription_1go_request($access_token, $msisdn) {
    $url = DJEZZY_BASE_URL . "/djezzy-api/api/v1/subscribers/$msisdn/subscription-product?include=";
    
    $headers = [
        "User-Agent: Djezzy/2.7.5",
        "Connection: Keep-Alive",
        "Accept: */*",
        "Accept-Encoding: gzip",
        "Authorization: Bearer $access_token",
        "Content-Type: application/json; charset=utf-8",
        "x-csrf-token: " . CSRF_TOKEN_1GO
    ];
    
    $data = [
        "data" => [
            "id" => "DOVINTSPEEDDAY1GoPRE",
            "type" => "products"
        ]
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    return $http_code == 200;
}

function send_subscription_1gofb_request($access_token, $msisdn) {
    $url = DJEZZY_BASE_URL . "/djezzy-api/api/v1/subscribers/$msisdn/subscription-product?include=";
    
    $headers = [
        'User-Agent: Djezzy/2.7.5',
        'Connection: Keep-Alive',
        'Accept-Encoding: gzip',
        'Content-Type: application/json',
        'Authorization: Bearer ' . $access_token,
        'x-csrf-token: ' . CSRF_TOKEN_1GO_FB
    ];
    
    $data = [
        "data" => [
            "id" => "1GBFB3DAY",
            "type" => "products"
        ]
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    return $http_code == 200;
}

function send_invitation_request($access_token, $msisdn, $b_number) {
    $url = DJEZZY_BASE_URL . "/djezzy-api/api/v1/subscribers/$msisdn/member-get-member?include=";
    
    $headers = [
        "Accept: */*",
        "Content-Type: application/json; charset=utf-8",
        "User-Agent: Djezzy/2.6.7",
        "Connection: Keep-Alive",
        "x-csrf-token: " . CSRF_TOKEN_SUBSCRIPTION,
        "Authorization: Bearer $access_token",
        "Host: apim.djezzy.dz"
    ];

    $data = [
        "data" => [
            "id" => "MGM-BONUS",
            "type" => "products",
            "meta" => [
                "services" => [
                    "b-number" => "213" . substr($b_number, 1),
                    "id" => "MemberGetMember"
                ]
            ]
        ]
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $response = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($http_code == 200) {
        $response_data = json_decode($response, true);
        if (isset($response_data["body"])) {
            $body = json_decode($response_data["body"], true);
            if ($body["code"] == 200 && $body["message"] == "OK") {
                return [true, "OK"];
            } elseif ($body["code"] == 429 && $body["message"] == "INVITATIONS_LIMIT_REACHED") {
                return [false, "INVITATIONS_LIMIT_REACHED"];
            } elseif ($body["code"] == 419 && $body["message"] == "B_NUMBER_ACCEPTED_INVITATION") {
                return [false, "B_NUMBER_ACCEPTED_INVITATION"];
            } elseif ($body["code"] == 500 && $body["message"] == "INTERNAL_ERROR") {
                return [false, "INTERNAL_ERROR"];
            }
        }
    }
    
    return [false, "UNKNOWN_ERROR"];
}

// Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function handle_message($sender_id, $message_text) {
    $user_state = get_user_session($sender_id);
    
    if (!$user_state) {
        $welcome_msg = "Ù…Ø±Ø­Ø¨Ø§ ğŸ‘‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª ØªØ³Ø¬ÙŠÙ„ Ø¬ÙŠØ²ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯! ğŸ‰

âœ”ï¸ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
â€¢ Ø­ÙØ¸ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
â€¢ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„
â€¢ ØªÙØ¹ÙŠÙ„ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¹Ø±ÙˆØ¶
â€¢ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ù„Ø±ØµÙŠØ¯

Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¬ÙŠØ²ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07):";
        send_facebook_message($sender_id, $welcome_msg);
        $user_state = ["stage" => "awaiting_msisdn"];
        save_user_session($sender_id, $user_state);
        return;
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ©
    if (strpos($message_text, "ğŸ‘") !== false) {
        send_facebook_message($sender_id, "ğŸ‘");
        return;
    }

    if ($user_state["stage"] == "awaiting_msisdn") {
        $msisdn = preg_replace('/\D/', '', $message_text);
        if (strlen($msisdn) == 10 && strpos($msisdn, "07") === 0) {
            $formatted_msisdn = '213' . substr($msisdn, 1);
            $user_data = get_user_from_db($formatted_msisdn);
            
            if ($user_data) {
                $display_msisdn = substr($msisdn, 0, 4) . "xxxx" . substr($msisdn, -2);
                send_facebook_message($sender_id, "ğŸ”“ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ! Ø§Ù„Ø±Ù‚Ù… $display_msisdn Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹.");
                list($success, $access_token) = get_access_token_for_user($formatted_msisdn);
                if ($success) {
                    $quick_replies = [
                        [
                            "content_type" => "text",
                            "title" => "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ğŸ“±",
                            "payload" => "SIM_CARD_INFO"
                        ],
                        [
                            "content_type" => "text",
                            "title" => "ØªÙØ¹ÙŠÙ„ 2GğŸ‰ğŸ",
                            "payload" => "GIFTWALKWIN"
                        ],
                        [
                            "content_type" => "text",
                            "title" => "Ø¹Ø±Ø¶ğŸ”–70Ø¯Ø¬[4Ø¬ÙŠÙ‚Ø§]",
                            "payload" => "BTLINTSPEEDDAY2Go"
                        ],
                        [
                            "content_type" => "text",
                            "title" => "Ø¹Ø±Ø¶ 1Go/100DağŸâ¤ï¸",
                            "payload" => "DOVINTSPEEDDAY1GoPRE"
                        ],
                        [
                            "content_type" => "text",
                            "title" => "1GO/FB/70Da/3Ø£ÙŠØ§Ù…ğŸ‰",
                            "payload" => "1GBFB3DAY"
                        ],
                        [
                            "content_type" => "text",
                            "title" => "Ø§Ø±Ø³Ø§Ù„ Ø¯Ø¹ÙˆØ©",
                            "payload" => "SEND_INVITATION"
                        ]
                    ];
                    send_facebook_message($sender_id, "Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© ğŸ”–:", $quick_replies);
                    $user_state = [
                        "stage" => "awaiting_confirmation", 
                        "msisdn" => $formatted_msisdn, 
                        "access_token" => $access_token
                    ];
                    save_user_session($sender_id, $user_state);
                } else {
                    send_facebook_message($sender_id, "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø³Ø¬Ù„. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„.");
                    $user_state = ["stage" => "awaiting_msisdn"];
                    save_user_session($sender_id, $user_state);
                }
            } else {
                list($success, $registered_msisdn) = register_msisdn($msisdn);
                if ($success) {
                    $display_msisdn = substr($msisdn, 0, 4) . "xxxx" . substr($msisdn, -2);
                    send_facebook_message($sender_id, "ğŸ“± ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© Ø¥Ù„Ù‰ $display_msisdn ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø².");
                    $user_state = ["stage" => "awaiting_otp", "msisdn" => $registered_msisdn];
                    save_user_session($sender_id, $user_state);
                } else {
                    send_facebook_message($sender_id, "âŒ Ø®Ø·Ø§ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±");
                }
            }
        } else {
            send_facebook_message($sender_id, "âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø¯Ø®Ø§Ù„ Ø§Ø±Ù‚Ø§Ù… Ø¬ÙŠØ²ÙŠ ÙÙ‚Ø· (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07)");
        }

    } elseif ($user_state["stage"] == "awaiting_otp") {
        $otp = preg_match('/\d{6}/', $message_text, $matches) ? $matches[0] : null;
        $msisdn_in_message = preg_match('/\d{10}/', $message_text, $matches) ? $matches[0] : null;

        if ($msisdn_in_message && strpos($msisdn_in_message, "07") === 0) {
            $new_msisdn = $msisdn_in_message;
            list($success, $registered_msisdn) = register_msisdn($new_msisdn);
            if ($success) {
                $display_msisdn = substr($new_msisdn, 0, 4) . "xxxx" . substr($new_msisdn, -2);
                send_facebook_message($sender_id, "ğŸ“± ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© Ø¥Ù„Ù‰ $display_msisdn ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø².");
                $user_state = ["stage" => "awaiting_otp", "msisdn" => $registered_msisdn];
                save_user_session($sender_id, $user_state);
            } else {
                send_facebook_message($sender_id, "âŒ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø¯Ø±Ø¬ Ø®Ø§Ø·Ø¦ØŒ Ø§Ø¹Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø±Ù‚Ù…Ùƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯ ğŸ“©");
            }
        } elseif ($otp) {
            $otp = $otp;
            list($success, $refresh_token) = get_auth_token($user_state["msisdn"], $otp);
            if ($success) {
                list($success, $access_token) = refresh_access_token($refresh_token);
                if ($success) {
                    save_user_to_db($user_state["msisdn"], $refresh_token, $access_token);
                    
                    $quick_replies = [
                        [
                            "content_type" => "text",
                            "title" => "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ğŸ“±",
                            "payload" => "SIM_CARD_INFO"
                        ],
                        [
                            "content_type" => "text",
                            "title" => "ØªÙØ¹ÙŠÙ„ 2GğŸ‰ğŸ",
                            "payload" => "GIFTWALKWIN"
                        ],
                        [
                            "content_type" => "text",
                            "title" => "Ø¹Ø±Ø¶ğŸ”–70Ø¯Ø¬[4Ø¬ÙŠÙ‚Ø§]",
                            "payload" => "BTLINTSPEEDDAY2Go"
                        ],
                        [
                            "content_type" => "text",
                            "title" => "Ø¹Ø±Ø¶ 1Go/100DağŸâ¤ï¸",
                            "payload" => "DOVINTSPEEDDAY1GoPRE"
                        ],
                        [
                            "content_type" => "text",
                            "title" => "1GO/FB/70Da/3Ø£ÙŠØ§Ù…ğŸ‰",
                            "payload" => "1GBFB3DAY"
                        ],
                        [
                            "content_type" => "text",
                            "title" => "Ø§Ø±Ø³Ø§Ù„ Ø¯Ø¹ÙˆØ©",
                            "payload" => "SEND_INVITATION"
                        ]
                    ];
                    send_facebook_message($sender_id, "ğŸ‰ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø±Ù‚Ù…Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø¨Ø¯ÙˆÙ† Ø±Ù…Ø² ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.\n\nØ§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© ğŸ”–:", $quick_replies);
                    $user_state = [
                        "stage" => "awaiting_confirmation", 
                        "msisdn" => $user_state["msisdn"], 
                        "access_token" => $access_token
                    ];
                    save_user_session($sender_id, $user_state);
                } else {
                    send_facebook_message($sender_id, "âŒ Ø®Ø·Ø§ ÙÙŠ Ø³ÙŠØ±ÙØ± Djezzy Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 5 Ø¯Ù‚Ø§Ø¦Ù‚");
                    $user_state = ["stage" => "awaiting_msisdn"];
                    save_user_session($sender_id, $user_state);
                }
            } else {
                send_facebook_message($sender_id, "âŒ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø¯Ø±Ø¬ Ø®Ø§Ø·Ø¦ØŒ Ø§Ø¹Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø±Ù‚Ù…Ùƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯ ğŸ“©");
            }
        } else {
            send_facebook_message($sender_id, "âŒ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø¯Ø±Ø¬ Ø®Ø§Ø·Ø¦ØŒ Ø§Ø¹Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø±Ù‚Ù…Ùƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯ ğŸ“©");
        }
    
    } elseif ($user_state["stage"] == "awaiting_confirmation") {
        if ($message_text == "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ğŸ“±") {
            send_facebook_message($sender_id, "â³ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...");
            list($success, $sim_info) = get_sim_card_info($user_state["access_token"], $user_state["msisdn"]);
            if ($success) {
                $formatted_info = format_sim_card_info($sim_info);
                send_facebook_message($sender_id, $formatted_info);
            } else {
                send_facebook_message($sender_id, "âŒ $sim_info");
            }
            
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            $quick_replies = [
                [
                    "content_type" => "text",
                    "title" => "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ğŸ“±",
                    "payload" => "SIM_CARD_INFO"
                ],
                [
                    "content_type" => "text",
                    "title" => "ØªÙØ¹ÙŠÙ„ 2GğŸ‰ğŸ",
                    "payload" => "GIFTWALKWIN"
                ],
                [
                    "content_type" => "text",
                    "title" => "Ø¹Ø±Ø¶ğŸ”–70Ø¯Ø¬[4Ø¬ÙŠÙ‚Ø§]",
                    "payload" => "BTLINTSPEEDDAY2Go"
                ],
                [
                    "content_type" => "text",
                    "title" => "Ø¹Ø±Ø¶ 1Go/100DağŸâ¤ï¸",
                    "payload" => "DOVINTSPEEDDAY1GoPRE"
                ],
                [
                    "content_type" => "text",
                    "title" => "1GO/FB/70Da/3Ø£ÙŠØ§Ù…ğŸ‰",
                    "payload" => "1GBFB3DAY"
                ],
                [
                    "content_type" => "text",
                    "title" => "Ø§Ø±Ø³Ø§Ù„ Ø¯Ø¹ÙˆØ©",
                    "payload" => "SEND_INVITATION"
                ]
            ];
            send_facebook_message($sender_id, "Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø© Ø£Ø®Ø±Ù‰:", $quick_replies);
        
        } elseif ($message_text == "ØªÙØ¹ÙŠÙ„ 2GğŸ‰ğŸ") {
            $subscription_success = send_subscription_product1_request($user_state["access_token"], $user_state["msisdn"]);
            if ($subscription_success) {
                $display_msisdn = substr($user_state['msisdn'], 3, 4) . "xxxx" . substr($user_state['msisdn'], -2);
                send_facebook_message($sender_id, "ğŸ‰ $display_msisdn ØªÙ… ØªÙØ¹ÙŠÙ„ 2G Ø¨Ù†Ø¬Ø§Ø­!");
            } else {
                send_facebook_message($sender_id, "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ - ÙŠØ¨Ø¯Ùˆ Ø§Ù†Ùƒ Ø³Ø¬Ù„Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙˆÙ„Ù… ØªÙƒÙ…Ù„ Ø§Ø³Ø¨ÙˆØ¹Ø§ ğŸ“†");
            }
            $user_state = ["stage" => "awaiting_msisdn"];
            save_user_session($sender_id, $user_state);
        
        } elseif ($message_text == "Ø¹Ø±Ø¶ğŸ”–70Ø¯Ø¬[4Ø¬ÙŠÙ‚Ø§]") {
            $subscription_success = send_subscription_product2_request($user_state["access_token"], $user_state["msisdn"]);
            if ($subscription_success) {
                $display_msisdn = substr($user_state['msisdn'], 3, 4) . "xxxx" . substr($user_state['msisdn'], -2);
                send_facebook_message($sender_id, "ğŸ‰ $display_msisdn ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­! ğŸ˜");
            } else {
                send_facebook_message($sender_id, "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø§ - Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠğŸ’° Ù„ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ğŸ”–");
            }
            $user_state = ["stage" => "awaiting_msisdn"];
            save_user_session($sender_id, $user_state);
        
        } elseif ($message_text == "Ø¹Ø±Ø¶ 1Go/100DağŸâ¤ï¸") {
            $subscription_success = send_subscription_1go_request($user_state["access_token"], $user_state["msisdn"]);
            if ($subscription_success) {
                $display_msisdn = substr($user_state['msisdn'], 3, 4) . "xxxx" . substr($user_state['msisdn'], -2);
                send_facebook_message($sender_id, "ğŸ‰ $display_msisdn ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¹Ø±Ø¶ 1Go/100Da Ø¨Ù†Ø¬Ø§Ø­! ğŸ˜");
            } else {
                send_facebook_message($sender_id, "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø§ - Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠğŸ’° Ù„ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ğŸ”–");
            }
            $user_state = ["stage" => "awaiting_msisdn"];
            save_user_session($sender_id, $user_state);
        
        } elseif ($message_text == "1GO/FB/70Da/3Ø£ÙŠØ§Ù…ğŸ‰") {
            $subscription_success = send_subscription_1gofb_request($user_state["access_token"], $user_state["msisdn"]);
            if ($subscription_success) {
                $display_msisdn = substr($user_state['msisdn'], 3, 4) . "xxxx" . substr($user_state['msisdn'], -2);
                send_facebook_message($sender_id, "ğŸ‰ $display_msisdn ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¹Ø±Ø¶ 1GO/FB/70Da/3Ø£ÙŠØ§Ù… Ø¨Ù†Ø¬Ø§Ø­! ğŸ˜");
            } else {
                send_facebook_message($sender_id, "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø§ - Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠğŸ’° Ù„ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ğŸ”–");
            }
            $user_state = ["stage" => "awaiting_msisdn"];
            save_user_session($sender_id, $user_state);
        
        } elseif ($message_text == "Ø§Ø±Ø³Ø§Ù„ Ø¯Ø¹ÙˆØ©") {
            send_facebook_message($sender_id, "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø¥Ù„ÙŠÙ‡ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07):");
            $user_state = [
                "stage" => "awaiting_invitation_number", 
                "msisdn" => $user_state["msisdn"], 
                "access_token" => $user_state["access_token"]
            ];
            save_user_session($sender_id, $user_state);
        }
    
    } elseif ($user_state["stage"] == "awaiting_invitation_number") {
        $b_number = preg_replace('/\D/', '', $message_text);
        if (strlen($b_number) == 10 && strpos($b_number, "07") === 0) {
            $success_count = 0;
            $error_messages = [];
            
            for ($i = 0; $i < 3; $i++) {
                list($invitation_success, $response_message) = send_invitation_request($user_state["access_token"], $user_state["msisdn"], $b_number);
                if ($invitation_success) {
                    $success_count++;
                } else {
                    $error_messages[] = $response_message;
                }
            }
            
            if ($success_count > 0) {
                $display_b_number = substr($b_number, 0, 4) . "xxxx" . substr($b_number, -2);
                send_facebook_message($sender_id, "ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ $display_b_number   Ø§Ù„Ø§Ù† Ù…Ø§Ø¹Ù„ÙŠÙƒ ÙØ¹Ù„Ù‡ Ù‡Ùˆ ÙÙ‚Ø· Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ø¹Ùˆ Ø§Ù„ÙŠÙ†Ø§ ÙˆØ§Ù„Ø±Ù…Ø² Ø§Ù„Ø°ÙŠ  ÙˆØµÙ„ ÙÙŠ Ø±Ø³Ø§Ù„Ø© DJEZZY APP Ø§Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø· Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬ÙŠØ²ÙŠ Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ø¹Ùˆ");
            } else {
                if (in_array("INVITATIONS_LIMIT_REACHED", $error_messages)) {
                    send_facebook_message($sender_id, "Ù„Ù… ØªÙƒÙ…Ù„ Ø§Ø³Ø¨ÙˆØ¹Ø§");
                } elseif (in_array("B_NUMBER_ACCEPTED_INVITATION", $error_messages)) {
                    send_facebook_message($sender_id, "Ù„Ù‚Ø¯ ØªÙ…Øª Ø¯Ø¹ÙˆØ© Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ù† Ù‚Ø¨Ù„");
                } elseif (in_array("INTERNAL_ERROR", $error_messages)) {
                    send_facebook_message($sender_id, "Ø®Ø·Ø§ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                } else {
                    send_facebook_message($sender_id, "Ø®Ø·Ø§ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§                     Ù…Ù† Ø§Ù„Ø§Ø­Ø³Ù† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ø§ÙˆÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 02 Ù„ÙŠÙ„Ø§ Ø§Ù„Ù‰ 10 ØµØ¨Ø§Ø­Ø§ ");
                }
            }
        } else {
            send_facebook_message($sender_id, "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙŠØ²ÙŠ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07");
        }
        
        $user_state = ["stage" => "awaiting_msisdn"];
        save_user_session($sender_id, $user_state);
    }
}

// Webhook handlers for Facebook
function verify_webhook() {
    if (isset($_GET['hub_verify_token']) && isset($_GET['hub_challenge'])) {
        $verify_token = 'Nactivi_2025'; // Ø¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
        if ($_GET['hub_verify_token'] === $verify_token) {
            echo $_GET['hub_challenge'];
            exit;
        } else {
            http_response_code(403);
            echo "Invalid verify token";
            exit;
        }
    }
}

function handle_webhook() {
    $input = json_decode(file_get_contents('php://input'), true);
    
    if (!$input) {
        http_response_code(400);
        echo "Invalid JSON";
        return;
    }
    
    // Log the incoming webhook for debugging
    error_log("Webhook received: " . json_encode($input));
    
    if (isset($input['object']) && $input['object'] === 'page') {
        foreach ($input['entry'] as $entry) {
            if (isset($entry['messaging'])) {
                foreach ($entry['messaging'] as $messaging) {
                    $sender_id = $messaging['sender']['id'];
                    
                    if (isset($messaging['message']['text'])) {
                        $message_text = $messaging['message']['text'];
                        handle_message($sender_id, $message_text);
                    } elseif (isset($messaging['postback'])) {
                        // Handle postback payloads
                        $payload = $messaging['postback']['payload'];
                        handle_message($sender_id, $payload);
                    }
                }
            }
        }
        
        echo 'EVENT_RECEIVED';
    } else {
        http_response_code(404);
        echo "Not a page event";
    }
}

// Main execution
if ($_SERVER['REQUEST_METHOD'] === 'GET') {
    verify_webhook();
} elseif ($_SERVER['REQUEST_METHOD'] === 'POST') {
    handle_webhook();
} else {
    http_response_code(405);
    echo "Method not allowed";
}

// For CLI execution (fallback polling)
if (php_sapi_name() === 'cli') {
    echo "Starting Facebook Bot with SIM Card Info Feature...\n";
    
    $last_checked = time();
    $processed_message_ids = [];
    
    while (true) {
        try {
            $url = "https://graph.facebook.com/v11.0/me/conversations?fields=messages.limit(1){message,from,id}&since=$last_checked&access_token=" . FACEBOOK_PAGE_ACCESS_TOKEN;
            
            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $url);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_TIMEOUT, 30);
            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            curl_close($ch);
            
            if ($http_code == 200) {
                $data = json_decode($response, true);
                $messages = $data['data'] ?? [];
                
                foreach ($messages as $conversation) {
                    foreach ($conversation['messages']['data'] as $message) {
                        $message_id = $message['id'];
                        if (!in_array($message_id, $processed_message_ids)) {
                            $sender_id = $message['from']['id'];
                            $message_text = $message['message'];
                            echo "Received message from $sender_id: $message_text\n";
                            
                            handle_message($sender_id, $message_text);
                            $processed_message_ids[] = $message_id;
                            
                            // Keep only last 1000 message IDs to prevent memory issues
                            if (count($processed_message_ids) > 1000) {
                                array_shift($processed_message_ids);
                            }
                        }
                    }
                }
            }
        } catch (Exception $e) {
            echo "Error polling messages: " . $e->getMessage() . "\n";
        }
        
        $last_checked = time();
        sleep(2);
    }
}

?>
